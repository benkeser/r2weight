<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Compute the optimal cross-validated R-squared for several outcomes • r2weight</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="jquery.sticky-kit.min.js"></script><script src="pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">r2weight</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li>
  <a href="news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="contents col-md-9">
    <div id="r2weight" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#r2weight" class="anchor"></a>r2weight</h1></div>
<p>David Benkeser</p>
<p><a href="https://travis-ci.org/benkeser/drtml"><img src="https://travis-ci.org/benkeser/r2weight.svg?branch=master" alt="Travis-CI Build Status"></a> <a href="https://ci.appveyor.com/project/benkeser/survtmle"><img src="https://ci.appveyor.com/api/projects/status/github/benkeser/r2weight?branch=master&amp;svg=true" alt="AppVeyor Build Status"></a> <a href="http://www.r-pkg.org/pkg/r2weight"><img src="http://www.r-pkg.org/badges/version/r2weight" alt="CRAN"></a> <a href="http://www.repostatus.org/#active"><img src="http://www.repostatus.org/badges/latest/active.svg" alt="Project Status: Active - The project has reached a stable, usable state and is being actively developed."></a> <a href="http://opensource.org/licenses/MIT"><img src="http://img.shields.io/badge/license-MIT-brightgreen.svg" alt="MIT license"></a></p>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This package can be used to learn the convex combination of a multivariate outcome that maximizes cross-validated R-squared of a Super Learner-based prediction. Super Learner is an ensemble machine learning method with an associated <a href="https://github.com/ecpolley/SuperLearner">R package</a> written by Eric Polley. The <code>SuperLearner</code> package provides a flexible interface for utilizing user-written wrappers to perform ensemble learning. A short tutorial on use of the Super Learner package can be found <a href="http://benkeser.github.io/sllecture/">here</a>.</p>
<p>In addition to estimating the best convex combination of outcomes for the sake of prediction, the <code>r2weight</code> package simultaneously estimates a function for predicting this learned convex combination and can compute a cross-validated estimate of the R-squared of this prediction algorithm for predicting the convex combination of outcomes. The package also computes influence function-based estimates of the standard error of the estimated performance metric that are used to construct confidence intervals and hypotheses tests. Finally, the package includes functions for computing variable importance measures for each variable.</p>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>The package can be installed directly from GitHub as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># install/load devtools package</span>
if(!(<span class="st">"devtools"</span> %in%<span class="st"> </span><span class="kw">row.names</span>(<span class="kw">installed.packages</span>()))){
    <span class="kw">install.packages</span>(<span class="st">"devtools"</span>)
}
<span class="kw">library</span>(<span class="st">"devtools"</span>)

<span class="co"># install/load r2weight from GitHub</span>
if(!(<span class="st">"r2weight"</span> %in%<span class="st"> </span><span class="kw">row.names</span>(<span class="kw">installed.packages</span>()))){
    <span class="kw">install_github</span>(<span class="st">"benkeser/r2weight"</span>)
}
<span class="kw">library</span>(<span class="st">"r2weight"</span>)</code></pre></div>
</div>
<div id="use" class="section level2">
<h2 class="hasAnchor">
<a href="#use" class="anchor"></a>Use</h2>
<p>The basic workflow of the package is to call the function <code>optWeight</code>, which estimates the optimal weights for the combined outcome. The function <code>r2_optWeight</code> can then be called using the <code>optWeight</code> object to obtain a cross-validated estimate of the R-squared for predicting the combined outcome.</p>
<p>Here we illustrate the method using simulated data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># sample size</span>
n &lt;-<span class="st"> </span><span class="dv">500</span>

<span class="co"># set the seed</span>
<span class="kw">set.seed</span>(<span class="dv">12345</span>)

<span class="co"># simulate nine covariate predictors</span>
x1 &lt;-<span class="st"> </span><span class="kw">runif</span>(n,<span class="dv">0</span>,<span class="dv">4</span>)
x2 &lt;-<span class="st"> </span><span class="kw">runif</span>(n,<span class="dv">0</span>,<span class="dv">4</span>)
x3 &lt;-<span class="st"> </span><span class="kw">runif</span>(n,<span class="dv">0</span>,<span class="dv">4</span>)
x4 &lt;-<span class="st"> </span><span class="kw">rbinom</span>(n,<span class="dv">1</span>,<span class="fl">0.75</span>)
x5 &lt;-<span class="st"> </span><span class="kw">rbinom</span>(n,<span class="dv">1</span>,<span class="fl">0.25</span>)
x6 &lt;-<span class="st"> </span><span class="kw">rbinom</span>(n,<span class="dv">1</span>,<span class="fl">0.5</span>)
x7 &lt;-<span class="st"> </span><span class="kw">runif</span>(n,<span class="dv">0</span>,<span class="dv">4</span>)
x8 &lt;-<span class="st"> </span><span class="kw">runif</span>(n,<span class="dv">0</span>,<span class="dv">4</span>)
x9 &lt;-<span class="st"> </span><span class="kw">runif</span>(n,<span class="dv">0</span>,<span class="dv">4</span>)
<span class="co"># put all predictors in single data.frame</span>
X &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x1=</span>x1, <span class="dt">x2=</span>x2, <span class="dt">x3=</span>x3, <span class="dt">x4=</span>x4, <span class="dt">x5=</span>x5, 
                <span class="dt">x6=</span>x6, <span class="dt">x7=</span>x7, <span class="dt">x8=</span>x8, <span class="dt">x9=</span>x9)

<span class="co"># simulate three outcomes</span>
y1 &lt;-<span class="st"> </span>x1 +<span class="st"> </span><span class="dv">2</span>*x2 +<span class="st"> </span><span class="dv">4</span>*x3 +<span class="st"> </span>x4 +<span class="st"> </span><span class="dv">2</span>*x5 +<span class="st"> </span><span class="dv">4</span>*x6 +<span class="st"> </span><span class="dv">2</span>*x7 +<span class="st"> </span><span class="kw">rnorm</span>(n, <span class="dv">0</span>, <span class="dv">5</span>)
y2 &lt;-<span class="st"> </span>x1 +<span class="st"> </span><span class="dv">2</span>*x2 +<span class="st"> </span><span class="dv">4</span>*x3 +<span class="st"> </span>x4 +<span class="st"> </span><span class="dv">2</span>*x5 +<span class="st"> </span><span class="dv">4</span>*x6 +<span class="st"> </span><span class="dv">2</span>*x8 +<span class="st"> </span><span class="kw">rnorm</span>(n, <span class="dv">0</span>, <span class="dv">5</span>)
y3 &lt;-<span class="st"> </span>x1 +<span class="st"> </span><span class="dv">2</span>*x2 +<span class="st"> </span><span class="dv">4</span>*x3 +<span class="st"> </span>x4 +<span class="st"> </span><span class="dv">2</span>*x5 +<span class="st"> </span><span class="dv">4</span>*x6 +<span class="st"> </span><span class="dv">2</span>*x9 +<span class="st"> </span><span class="kw">rnorm</span>(n, <span class="dv">0</span>, <span class="dv">5</span>)
<span class="co"># put all outcomes in single data.frame</span>
Y &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">y1 =</span> y1, <span class="dt">y2 =</span> y2, <span class="dt">y3 =</span> y3)

<span class="co"># call optWeight using simple Super Learner library</span>
out1 &lt;-<span class="st"> </span><span class="kw"><a href="reference/optWeight.html">optWeight</a></span>(<span class="dt">Y =</span> Y, <span class="dt">X =</span> X, <span class="dt">SL.library =</span> <span class="kw">c</span>(<span class="st">"SL.mean"</span>,<span class="st">"SL.glm"</span>,<span class="st">"SL.step"</span>))

<span class="co"># print the object</span>
out1</code></pre></div>
<div class="sourceCode"><pre class="sourceCode R"><code class="sourceCode r">## 
## Optimal weights for prediction with SuperLearner  : 
## y1  :  0.371 
## y2  :  0.314 
## y3  :  0.315 
## 
##  
## R-squared for each outcome with SuperLearner  : 
##       R2  CI.l  CI.h
## y1 0.643 0.589 0.689
## y2 0.613 0.559 0.660
## y3 0.625 0.573 0.671</code></pre></div>
<p>The estimated optimal weights are shown (note that the true weights in this example are 1/3, 1/3, 1/3) along with the estimated cross validated R-squared for predicting each outcome using the Super Learner. There is an S3-method for predicting the combined outcome on new data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># generate new data</span>
newX &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x1=</span><span class="dv">1</span>, <span class="dt">x2=</span><span class="dv">1</span>, <span class="dt">x3=</span><span class="dv">1</span>, <span class="dt">x4=</span><span class="dv">1</span>, <span class="dt">x5=</span><span class="dv">1</span>, 
                   <span class="dt">x6=</span><span class="dv">1</span>, <span class="dt">x7=</span><span class="dv">1</span>, <span class="dt">x8=</span><span class="dv">1</span>, <span class="dt">x9=</span><span class="dv">1</span>)
<span class="co"># get prediction of combined outcome</span>
<span class="kw">predict</span>(out1, <span class="dt">newdata =</span> newX)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode R"><code class="sourceCode r">##          [,1]
## [1,] 15.80969</code></pre></div>
<p>We can call <code>r2_optWeight</code> to get an estimate of the cross-validated R-squared for predicting the combined outcome with Super Learner.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># cross-validated R-squared</span>
<span class="co"># set verbose = TRUE to see a progress bar</span>
r2.out1 &lt;-<span class="st"> </span><span class="kw"><a href="reference/r2_optWeight.html">r2_optWeight</a></span>(out1, <span class="dt">Y =</span> Y, <span class="dt">X =</span> X)

<span class="co"># print the output</span>
r2.out1</code></pre></div>
<div class="sourceCode"><pre class="sourceCode R"><code class="sourceCode r">## 
##  
## R-squared for each outcome with SuperLearner  : 
##       R2  CI.l  CI.h
## y1 0.643 0.589 0.689
## y2 0.613 0.559 0.660
## y3 0.625 0.573 0.671
## 
## 
##  
## R-squared for combined outcome with SuperLearner  : 
##                         R2  CI.l  CI.h
## weighted combination 0.815 0.784 0.841</code></pre></div>
<p>The R-squared for each individual outcome is shown, as well as for the combined outcome. In this example, the true R-squared for individual outcomes is about 0.6 and for the combined outcome about 0.8.</p>
</div>
<div id="variable-importance" class="section level2">
<h2 class="hasAnchor">
<a href="#variable-importance" class="anchor"></a>Variable importance</h2>
<p>A measure of variable importance for a particular variable can be defined as the difference in R-squared for the combined outcome when including and excluding that variable. These measures can be estimated using the <code>r2_diff</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># measure importance of x9</span>
out2 &lt;-<span class="st"> </span><span class="kw"><a href="reference/optWeight.html">optWeight</a></span>(<span class="dt">Y =</span> Y, <span class="dt">X =</span> X[,<span class="dv">1</span>:<span class="dv">8</span>], <span class="dt">SL.library =</span> <span class="kw">c</span>(<span class="st">"SL.glm"</span>,<span class="st">"SL.mean"</span>,<span class="st">"SL.step"</span>))

<span class="co"># print output</span>
out2 </code></pre></div>
<div class="sourceCode"><pre class="sourceCode R"><code class="sourceCode r">## 
## Optimal weights for prediction with SuperLearner  : 
## y1  :  0.404 
## y2  :  0.349 
## y3  :  0.248 
## 
##  
## R-squared for each outcome with SuperLearner  : 
##       R2  CI.l  CI.h
## y1 0.643 0.590 0.690
## y2 0.614 0.561 0.661
## y3 0.525 0.463 0.581</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># compare to full fit to get importance for each individual outcome</span>
outDiff &lt;-<span class="st"> </span><span class="kw"><a href="reference/r2_diff.html">r2_diff</a></span>(out1, out2)
<span class="co"># difference in R-squared for first outcome</span>
<span class="co"># with confidence interval and p-value for two-sided test that </span>
<span class="co"># the difference equals 0</span>
outDiff$y1$diff</code></pre></div>
<div class="sourceCode"><pre class="sourceCode R"><code class="sourceCode r">##             est         CI.l         CI.h         p
## 1 -0.0006708281 -0.002014265 0.0006726093 0.3277368</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># for the third outcome</span>
outDiff$y3$diff</code></pre></div>
<div class="sourceCode"><pre class="sourceCode R"><code class="sourceCode r">##          est       CI.l     CI.h            p
## 1 0.09986118 0.06798041 0.131742 8.290725e-10</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># get R-squared for combined outcome excluding x9</span>
r2.out2 &lt;-<span class="st"> </span><span class="kw"><a href="reference/r2_optWeight.html">r2_optWeight</a></span>(out2, <span class="dt">Y =</span> Y, <span class="dt">X =</span> X[,<span class="dv">1</span>:<span class="dv">8</span>])

<span class="co"># print output, notice change in weights</span>
r2.out2</code></pre></div>
<div class="sourceCode"><pre class="sourceCode R"><code class="sourceCode r">## 
##  
## R-squared for each outcome with SuperLearner  : 
##       R2  CI.l  CI.h
## y1 0.643 0.590 0.690
## y2 0.614 0.561 0.661
## y3 0.525 0.463 0.581
## 
## 
##  
## R-squared for combined outcome with SuperLearner  : 
##                         R2  CI.l  CI.h
## weighted combination 0.804 0.772 0.832</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># compare to full fit to get importance for combined outcome</span>
outDiff.r2 &lt;-<span class="st"> </span><span class="kw"><a href="reference/r2_diff.html">r2_diff</a></span>(r2.out1, r2.out2)

<span class="co"># print output</span>
outDiff.r2</code></pre></div>
<div class="sourceCode"><pre class="sourceCode R"><code class="sourceCode r">## $diff
##          est        CI.l       CI.h          p
## 1 0.01067995 0.002252427 0.01910748 0.01299872
## 
## $ratio
##         est      CI.l      CI.h          p
## 1 0.9454212 0.9049312 0.9877229 0.01196758
## 
## $type
## [1] "r2_optWeight"
## 
## $Ynames
## [1] "y1" "y2" "y3"
## 
## attr(,"class")
## [1] "r2_diff"</code></pre></div>
</div>
<div id="license" class="section level2">
<h2 class="hasAnchor">
<a href="#license" class="anchor"></a>License</h2>
<p>© 2016-2017 <a href="http://www.benkeserstatistics.com">David C. Benkeser</a></p>
<p>The contents of this repository are distributed under the MIT license. See below for details:</p>
<pre><code>The MIT License (MIT)

Copyright (c) 2016-2017 David C. Benkeser

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.</code></pre>
</div>
</div>
  </div>

  <div class="col-md-3" id="sidebar">
    <h2>License</h2>
<p><a href="https://opensource.org/licenses/mit-license.php">MIT</a></p>
<h2>Developers</h2>
<ul class="list-unstyled">
<li>David Benkeser <br><small class="roles"> Author, maintainer </small> </li>
</ul>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by David Benkeser.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
